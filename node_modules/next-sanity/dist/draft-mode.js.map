{"version":3,"file":"draft-mode.js","sources":["../src/draft-mode/define-enable-draft-mode.ts"],"sourcesContent":["import {validatePreviewUrl} from '@sanity/preview-url-secret'\nimport {perspectiveCookieName} from '@sanity/preview-url-secret/constants'\nimport {cookies, draftMode} from 'next/headers'\nimport {redirect} from 'next/navigation'\n\nimport type {SanityClient} from '../client'\n\n/**\n * @public\n */\nexport interface DefineEnableDraftModeOptions {\n  client: SanityClient\n  /**\n   * Force secure cookies in development mode.\n   * Enable this when using Next.js --experimental-https flag.\n   * This option has no effect in production (cookies are always secure).\n   * @defaultValue false\n   */\n  secureDevMode?: boolean\n}\n\n/**\n * @public\n */\nexport interface EnableDraftMode {\n  GET: (request: Request) => Promise<Response>\n}\n\n/**\n * Sets up an API route for enabling draft mode, can be paired with the `previewUrl.previewMode.enable` in `sanity/presentation`.\n * Can also be used with `sanity-plugin-iframe-pane`.\n * @example\n * ```ts\n * // src/app/api/draft-mode/enable/route.ts\n *\n * import { defineEnableDraftMode } from \"next-sanity/draft-mode\";\n * import { client } from \"@/sanity/lib/client\";\n *\n * export const { GET } = defineEnableDraftMode({\n *   client: client.withConfig({ token: process.env.SANITY_API_READ_TOKEN }),\n * });\n * ```\n *\n * @public\n */\nexport function defineEnableDraftMode(options: DefineEnableDraftModeOptions): EnableDraftMode {\n  const {client} = options\n  return {\n    GET: async (request: Request) => {\n      // eslint-disable-next-line no-warning-comments\n      // @TODO check if already in draft mode at a much earlier stage, and skip validation\n\n      const {\n        isValid,\n        redirectTo = '/',\n        studioPreviewPerspective,\n      } = await validatePreviewUrl(client, request.url)\n      if (!isValid) {\n        return new Response('Invalid secret', {status: 401})\n      }\n\n      const draftModeStore = await draftMode()\n\n      // Let's enable draft mode if it's not already enabled\n      if (!draftModeStore.isEnabled) {\n        draftModeStore.enable()\n      }\n\n      const isProduction = process.env.NODE_ENV === 'production'\n\n      // We can't auto-detect HTTPS in dev due to Next.js limitations,\n      // so we need an explicit option\n      const isSecure = isProduction || (options.secureDevMode ?? false)\n\n      // Override cookie header for draft mode for usage in live-preview\n      // https://github.com/vercel/next.js/issues/49927\n      const cookieStore = await cookies()\n      const cookie = cookieStore.get('__prerender_bypass')!\n      cookieStore.set({\n        name: '__prerender_bypass',\n        value: cookie?.value,\n        httpOnly: true,\n        path: '/',\n        secure: isSecure,\n        sameSite: isSecure ? 'none' : 'lax',\n      })\n\n      if (studioPreviewPerspective) {\n        cookieStore.set({\n          name: perspectiveCookieName,\n          value: studioPreviewPerspective,\n          httpOnly: true,\n          path: '/',\n          secure: isSecure,\n          sameSite: isSecure ? 'none' : 'lax',\n        })\n      }\n\n      // the `redirect` function throws, and eventually returns a Promise<Response>. TSC doesn't \"see\" that so we have to tell it\n      return redirect(redirectTo) as Promise<Response>\n    },\n  }\n}\n"],"names":[],"mappings":";;;;AA6CO,SAAS,sBAAsB,SAAwD;AAC5F,QAAM,EAAC,WAAU;AACjB,SAAO;AAAA,IACL,KAAK,OAAO,YAAqB;AAI/B,YAAM;AAAA,QACJ;AAAA,QACA,aAAa;AAAA,QACb;AAAA,MAAA,IACE,MAAM,mBAAmB,QAAQ,QAAQ,GAAG;AAChD,UAAI,CAAC;AACH,eAAO,IAAI,SAAS,kBAAkB,EAAC,QAAQ,KAAI;AAGrD,YAAM,iBAAiB,MAAM,UAAA;AAGxB,qBAAe,aAClB,eAAe,OAAA;AAOjB,YAAM,WAJe,QAAQ,IAAI,aAAa,iBAIZ,QAAQ,iBAAiB,KAIrD,cAAc,MAAM,QAAA,GACpB,SAAS,YAAY,IAAI,oBAAoB;AACnD,aAAA,YAAY,IAAI;AAAA,QACd,MAAM;AAAA,QACN,OAAO,QAAQ;AAAA,QACf,UAAU;AAAA,QACV,MAAM;AAAA,QACN,QAAQ;AAAA,QACR,UAAU,WAAW,SAAS;AAAA,MAAA,CAC/B,GAEG,4BACF,YAAY,IAAI;AAAA,QACd,MAAM;AAAA,QACN,OAAO;AAAA,QACP,UAAU;AAAA,QACV,MAAM;AAAA,QACN,QAAQ;AAAA,QACR,UAAU,WAAW,SAAS;AAAA,MAAA,CAC/B,GAII,SAAS,UAAU;AAAA,IAC5B;AAAA,EAAA;AAEJ;"}