{"version":3,"file":"SanityLiveStream.js","sources":["../../src/client-components/live-stream/SanityLiveStream.tsx"],"sourcesContent":["import {\n  type ClientPerspective,\n  type ContentSourceMap,\n  type InitializedClientConfig,\n  type QueryParams,\n} from '@sanity/client'\nimport {stegaEncodeSourceMap} from '@sanity/client/stega'\nimport type {LoaderControllerMsg} from '@sanity/presentation-comlink'\nimport {dequal} from 'dequal/lite'\nimport {useCallback, useEffect, useState, useSyncExternalStore} from 'react'\nimport * as React from 'react'\nimport {useEffectEvent} from 'use-effect-event'\nimport {comlinkListeners, comlink as comlinkSnapshot} from '../../hooks/context'\n\nconst use: typeof React.use =\n  'use' in React\n    ? // @ts-expect-error this is fine\n      React['u' + 's' + 'e']\n    : () => {\n        throw new TypeError('SanityLiveStream requires a React version with React.use()')\n      }\n\n/**\n * @public\n */\nexport interface SanityLiveStreamProps\n  extends Pick<InitializedClientConfig, 'projectId' | 'dataset'> {\n  query: string\n  params?: QueryParams\n  perspective?: Exclude<ClientPerspective, 'raw'>\n  stega?: boolean\n  initial: Promise<React.ReactNode>\n  children: (result: {\n    data: unknown\n    sourceMap: ContentSourceMap | null\n    tags: string[]\n  }) => Promise<React.ReactNode>\n}\n\nconst LISTEN_HEARTBEAT_INTERVAL = 10_000\n\n/**\n * @public\n */\nexport default function SanityLiveStream(props: SanityLiveStreamProps): React.JSX.Element | null {\n  const {query, dataset, params = {}, perspective, projectId, stega} = props\n\n  const subscribe = useCallback((listener: () => void) => {\n    comlinkListeners.add(listener)\n    return () => comlinkListeners.delete(listener)\n  }, [])\n\n  const comlink = useSyncExternalStore(\n    subscribe,\n    () => comlinkSnapshot,\n    () => null,\n  )\n  const [children, setChildren] = useState<React.ReactNode | undefined>(undefined)\n\n  const handleQueryHeartbeat = useEffectEvent((comlink: NonNullable<typeof comlinkSnapshot>) => {\n    comlink.post('loader/query-listen', {\n      projectId: projectId!,\n      dataset: dataset!,\n      perspective: perspective! as ClientPerspective,\n      query,\n      params: params!,\n      heartbeat: LISTEN_HEARTBEAT_INTERVAL,\n    })\n  })\n  const handleQueryChange = useEffectEvent(\n    (event: Extract<LoaderControllerMsg, {type: 'loader/query-change'}>['data']) => {\n      if (\n        dequal(\n          {\n            projectId,\n            dataset,\n            query,\n            params,\n          },\n          {\n            projectId: event.projectId,\n            dataset: event.dataset,\n            query: event.query,\n            params: event.params,\n          },\n        )\n      ) {\n        const {result, resultSourceMap, tags} = event\n        const data = stega\n          ? stegaEncodeSourceMap(result, resultSourceMap, {enabled: true, studioUrl: '/'})\n          : result\n        // eslint-disable-next-line no-console\n        // console.log('server function streaming is disabled', {\n        //   startTransition,\n        //   setPromise,\n        //   data,\n        //   resultSourceMap,\n        //   tags,\n        // })\n        // console.log('rendering with server action')\n        // startTransition(() =>\n        //   setPromise(\n        //     props.children({\n        //       data,\n        //       sourceMap: resultSourceMap!,\n        //       tags: tags || [],\n        //     }) as Promise<React.JSX.Element>,\n        //   ),\n        // )\n        // eslint-disable-next-line no-console\n        console.groupCollapsed('rendering with server action')\n        ;(\n          props.children({\n            data,\n            sourceMap: resultSourceMap!,\n            tags: tags || [],\n          }) as Promise<React.JSX.Element>\n        )\n          .then(\n            (children) => {\n              // eslint-disable-next-line no-console\n              console.log('setChildren(children)')\n              // startTransition(() => setChildren(children))\n              setChildren(children)\n            },\n            (reason: unknown) => {\n              // eslint-disable-next-line no-console\n              console.error('rendering with server action: render children error', reason)\n            },\n          )\n          // eslint-disable-next-line no-console\n          .finally(() => console.groupEnd())\n      }\n    },\n  )\n  useEffect(() => {\n    if (!comlink) return\n\n    const unsubscribe = comlink.on('loader/query-change', handleQueryChange)\n    const interval = setInterval(() => handleQueryHeartbeat(comlink), LISTEN_HEARTBEAT_INTERVAL)\n    return () => {\n      clearInterval(interval)\n      unsubscribe()\n    }\n  }, [comlink])\n\n  if (!comlink || children === undefined) {\n    return use(props.initial) as React.JSX.Element\n  }\n\n  return <>{children}</>\n}\nSanityLiveStream.displayName = 'SanityLiveStream'\n"],"names":["comlink","comlinkSnapshot","children"],"mappings":";;;;;;;AAcA,MAAM,MACJ,SAAS;AAAA;AAAA,EAEL,MAAM;AAAA,IACN,MAAM;AACJ,QAAM,IAAI,UAAU,4DAA4D;AAClF,GAmBA,4BAA4B;AAKlC,SAAwB,iBAAiB,OAAwD;AAC/F,QAAM,EAAC,OAAO,SAAS,SAAS,CAAA,GAAI,aAAa,WAAW,MAAA,IAAS,OAE/D,YAAY,YAAY,CAAC,cAC7B,iBAAiB,IAAI,QAAQ,GACtB,MAAM,iBAAiB,OAAO,QAAQ,IAC5C,EAAE,GAECA,YAAU;AAAA,IACd;AAAA,IACA,MAAMC;AAAAA,IACN,MAAM;AAAA,EAAA,GAEF,CAAC,UAAU,WAAW,IAAI,SAAsC,MAAS,GAEzE,uBAAuB,eAAe,CAACD,aAAiD;AAC5FA,aAAQ,KAAK,uBAAuB;AAAA,MAClC;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,WAAW;AAAA,IAAA,CACZ;AAAA,EACH,CAAC,GACK,oBAAoB;AAAA,IACxB,CAAC,UAA+E;AAC9E,UACE;AAAA,QACE;AAAA,UACE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QAAA;AAAA,QAEF;AAAA,UACE,WAAW,MAAM;AAAA,UACjB,SAAS,MAAM;AAAA,UACf,OAAO,MAAM;AAAA,UACb,QAAQ,MAAM;AAAA,QAAA;AAAA,MAChB,GAEF;AACA,cAAM,EAAC,QAAQ,iBAAiB,KAAA,IAAQ,OAClC,OAAO,QACT,qBAAqB,QAAQ,iBAAiB,EAAC,SAAS,IAAM,WAAW,IAAA,CAAI,IAC7E;AAoBJ,gBAAQ,eAAe,8BAA8B,GAEnD,MAAM,SAAS;AAAA,UACb;AAAA,UACA,WAAW;AAAA,UACX,MAAM,QAAQ,CAAA;AAAA,QAAC,CAChB,EAEA;AAAA,UACC,CAACE,cAAa;AAEZ,oBAAQ,IAAI,uBAAuB,GAEnC,YAAYA,SAAQ;AAAA,UACtB;AAAA,UACA,CAAC,WAAoB;AAEnB,oBAAQ,MAAM,uDAAuD,MAAM;AAAA,UAC7E;AAAA,QAAA,EAGD,QAAQ,MAAM,QAAQ,UAAU;AAAA,MACrC;AAAA,IACF;AAAA,EAAA;AAaF,SAXA,UAAU,MAAM;AACd,QAAI,CAACF,UAAS;AAEd,UAAM,cAAcA,UAAQ,GAAG,uBAAuB,iBAAiB,GACjE,WAAW,YAAY,MAAM,qBAAqBA,SAAO,GAAG,yBAAyB;AAC3F,WAAO,MAAM;AACX,oBAAc,QAAQ,GACtB,YAAA;AAAA,IACF;AAAA,EACF,GAAG,CAACA,SAAO,CAAC,GAER,CAACA,aAAW,aAAa,SACpB,IAAI,MAAM,OAAO,oCAGhB,SAAA,CAAS;AACrB;AACA,iBAAiB,cAAc;"}